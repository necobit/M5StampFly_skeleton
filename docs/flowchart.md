# M5StampFly コードフローチャート

## 概要

M5StampFlyは、M5Stamp（ESP32ベース）を使用した小型ドローン制御システムです。このドキュメントでは、M5StampFlyのコードフローと主要なコンポーネントについて説明します。

## システム構成

M5StampFlyは以下の主要なコンポーネントで構成されています：

- **センサー**: IMU（加速度計、ジャイロスコープ）、ToFセンサー（距離測定）
- **モーター制御**: 4つのモーターを制御するPWM出力
- **LED**: ステータス表示用のLED
- **ボタン**: モード切り替え用のボタン
- **ブザー**: 音声フィードバック用
- **テレメトリー**: データ送信用のシリアル通信

## 動作モード

M5StampFlyは以下の4つの動作モードを持っています：

1. **初期化モード (INIT_MODE)**: システムの初期化を行います
2. **平均化モード (AVERAGE_MODE)**: センサーのオフセット値を計算します
3. **飛行モード (FLIGHT_MODE)**: ドローンの飛行制御を行います
4. **着陸モード (PARKING_MODE)**: モーターを停止し、着陸状態を維持します

## メインフローチャート

```
┌─────────────────────┐
│      電源投入       │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     setup()実行     │
│   init_copter()     │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│    タイマー割込     │
│    設定(400Hz)      │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   loop()関数実行    │
│   loop_400Hz()      │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  update_loop400Hz() │
│  センサー値読み取り │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│    モード判定       │
└──────────┬──────────┘
           ↓
    ┌──────┴───────┐
    ↓      ↓       ↓      ↓
┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│初期化   │ │平均化    │ │飛行      │ │着陸      │
│モード   │ │モード    │ │モード    │ │モード    │
└────┬────┘ └─────┬────┘ └─────┬────┘ └─────┬────┘
     │            │            │            │
     ↓            ↓            ↓            ↓
┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│モーター │ │ジャイロ  │ │モーター  │ │モーター  │
│停止    │ │オフセット│ │制御      │ │停止      │
└────┬────┘ │計算      │ └─────┬────┘ └─────┬────┘
     │      └─────┬────┘       │            │
     │            │            │            │
     └────────────┼────────────┼────────────┘
                  ↓            ↓
          ┌───────────────┐    │
          │モード切替     │←───┘
          │(ボタン入力)   │
          └───────┬───────┘
                  ↓
          ┌───────────────┐
          │テレメトリー   │
          │データ送信     │
          └───────────────┘
```

## 初期化フロー (init_copter)

```
┌─────────────────────┐
│    init_copter()    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  モード初期化       │
│  (INIT_MODE)        │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│    LED初期化        │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  シリアル通信初期化 │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   モーター初期化    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   センサー初期化    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     RC初期化        │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   ボタン初期化      │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   ブザー初期化      │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  タイマー割込設定   │
│  (400Hz)            │
└─────────────────────┘
```

## センサー読み取りフロー (sensor_read)

```
┌─────────────────────┐
│    sensor_read()    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  IMUデータ読み取り  │
│ (加速度、角速度)    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  姿勢計算           │
│ (Madgwickフィルタ)  │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  ToFセンサー読み取り│
│  (高度情報)         │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  バッテリー電圧     │
│  読み取り           │
└─────────────────────┘
```

## モード遷移図

```
┌─────────────┐
│  INIT_MODE  │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ AVERAGE_MODE│
└──────┬──────┘
       │
       ↓
┌─────────────┐      ┌─────────────┐
│ PARKING_MODE│◄────►│ FLIGHT_MODE │
└─────────────┘      └─────────────┘
     (ボタン押下で切り替え)
```

## 主要なデータ構造

### StampFly構造体

```c
typedef struct{
    sensor_value_t sensor;  // センサー値
    flag_t flag;            // 状態フラグ
    counter_t counter;      // カウンター
    pidstruct_t pid;        // PID制御パラメータ
    times_t times;          // 時間管理
}stampfly_t;
```

### センサー値構造体

```c
typedef struct{
    float accx;             // X軸加速度
    float accy;             // Y軸加速度
    float accz;             // Z軸加速度
    float roll_rate;        // ロール角速度
    float pitch_rate;       // ピッチ角速度
    float yaw_rate;         // ヨー角速度
    float roll_angel;       // ロール角
    float pitch_angle;      // ピッチ角
    float yaw_angle;        // ヨー角
    float voltage;          // バッテリー電圧
    uint16_t bottom_tof_range; // 下向きToFセンサー距離
}sensor_value_t;
```

## モーター制御

M5StampFlyは4つのモーターを制御します：

- 前左 (FL): PIN_FRONT_LEFT (5)
- 前右 (FR): PIN_FRONT_RIGHT (42)
- 後左 (RL): PIN_REAR_LEFT (10)
- 後右 (RR): PIN_REAR_RIGHT (41)

モーターはPWM信号で制御され、周波数は150kHz、分解能は8ビットです。

## まとめ

M5StampFlyは、初期化、センサーオフセット計算、飛行、着陸の4つのモードを持つドローン制御システムです。400Hzのタイマー割り込みによってメインループが実行され、センサーの読み取り、モーター制御、テレメトリーデータの送信などが行われます。ボタン入力によって飛行モードと着陸モードを切り替えることができます。
